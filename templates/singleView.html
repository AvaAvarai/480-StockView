<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="../static/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../static/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../static/images/favicon-16x16.png">
    <link rel="manifest" href="static/images/site.webmanifest">
    <link rel="mask-icon" href="static/images/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="{{ url_for('static', filename='js/jquery-3.7.1.slim.min.js') }}"></script>
    <!-- Bootstrap JS -->
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='singleView.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300&display=swap" rel="stylesheet">
    <!-- LightweightCharts Development (swap 'development' to 'production' for stripped version) -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.development.js"></script>
    <title>{{ company_name }} ({{ ticker }}) - StockViewer WebApp</title>
</head>

<body>
    <div class="grey">
        <div class="container-fluid pt-2">
            <nav id="top-nav" class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <img src="{{ url_for('static', filename='images/moneyBagImage.jpg') }}" alt="Logo" id="logo">
                    <a href="/" class="text-decoration-none" style="color: inherit;">
                        <h1 class="mb-0 ms-2">StockViewer WebApp</h1>
                    </a>
                </div>
                <div id="nav-options">
                    <button class="btn btn-light" onclick="window.location.href='/';">Home</button>
                    <button class="btn btn-light" onclick="window.location.href='/about';">About</button>
                </div>
            </nav>
            <div class="left-adjust">
                <h2>{{ company_name }} ({{ ticker }})</h2><h5>On {{ company_overview.Exchange }} exchange, from {{ company_overview.Country }} country, in {{ company_overview.Currency }} currency.</h5>
                <p>Last Updated: {{ last_updated }}</p>
                <hr>
                <div>
                    <h4>Company Description</h4>
                    <p>{{ company_overview.Description }}</p>
                </div>
                
                <h3>Current Price: {{ price }} | Today's Open: {{ open_price }} | Previous Close: {{ previous_close }} | Volume: {{ volume }}</h3>
                  
                <div id="graph-container"></div>
                
                <!-- Key Financial Information -->
                
                <div class="financials-container">
                <!-- Column 1 -->
                <div class="financial-column">
                    <h4>Key Financial Information:</h4>
                    <p>Market Capitalization: {{ company_overview.MarketCapitalization }}</p>
                    <p>EBITDA: {{ company_overview.EBITDA }}</p>
                    <p>P/E Ratio: {{ company_overview.PERatio }}</p>
                    <p>EPS: {{ company_overview.EPS }}</p>
                    <p>Revenue TTM: {{ company_overview.RevenueTTM }}</p>
                    <p>PEGRatio: {{ company_overview.PEGRatio }}</p>
                    <p>Book Value: {{ company_overview.BookValue }}</p>
                    <p>Dividend Per Share: {{ company_overview.DividendPerShare }}</p>
                    <p>Dividend Yield: {{ company_overview.DividendYield }}</p>
                    <p>Revenue Per Share TTM: {{ company_overview.RevenuePerShareTTM }}</p>
                    <p>Profit Margin: {{ company_overview.ProfitMargin }}</p>
                    <p>Operating Margin TTM: {{ company_overview.OperatingMarginTTM }}</p>
                    <p>Return On Assets TTM: {{ company_overview.ReturnOnAssetsTTM }}</p>
                    <p>Return On Equity TTM: {{ company_overview.ReturnOnEquityTTM }}</p>
                    <p>Gross Profit TTM: {{ company_overview.GrossProfitTTM }}</p>
                    <p>Diluted EPS TTM: {{ company_overview.DilutedEPSTTM }}</p>
                    <p>Beta: {{ company_overview.Beta }}</p>
                </div>
                <!-- Column 2 -->
                <div class="financial-column">
                    <h4>Additional Financial Information:</h4>
                    <p>Quarterly Earnings Growth YOY: {{ company_overview.QuarterlyEarningsGrowthYOY }}</p>
                    <p>Quarterly Revenue Growth YOY: {{ company_overview.QuarterlyRevenueGrowthYOY }}</p>
                    <p>Analyst Target Price: {{ company_overview.AnalystTargetPrice }}</p>
                    <p>Analyst Ratings: Strong Buy {{ company_overview.AnalystRatingStrongBuy }}, Buy {{ company_overview.AnalystRatingBuy }}, Hold {{ company_overview.AnalystRatingHold }}, Sell {{ company_overview.AnalystRatingSell }}, Strong Sell {{ company_overview.AnalystRatingStrongSell }}</p>
                    <p>Trailing PE: {{ company_overview.TrailingPE }}</p>
                    <p>Forward PE: {{ company_overview.ForwardPE }}</p>
                    <p>Price to Sales Ratio TTM: {{ company_overview.PriceToSalesRatioTTM }}</p>
                    <p>Price to Book Ratio: {{ company_overview.PriceToBookRatio }}</p>
                    <p>EV to Revenue: {{ company_overview.EVToRevenue }}</p>
                    <p>EV to EBITDA: {{ company_overview.EVToEBITDA }}</p>
                    <p>52 Week High: {{ company_overview["52WeekHigh"] }}</p>
                    <p>52 Week Low: {{ company_overview["52WeekLow"] }}</p>
                    <p>50 Day Moving Average: {{ company_overview["50DayMovingAverage"] }}</p>
                    <p>200 Day Moving Average: {{ company_overview["200DayMovingAverage"] }}</p>
                    <p>Shares Outstanding: {{ company_overview.SharesOutstanding }}</p>
                    <p>Dividend Date: {{ company_overview.DividendDate }}</p>
                    <p>Ex-Dividend Date: {{ company_overview.ExDividendDate }}</p>
                </div>
            </div>
        </div>
    </div>
    <aside class="sidebar show" id="stockSidebar">
        <div class="list-group">
            {% for ticker, name in stock_tickers.items() %}
            <a href="/view/{{ ticker }}" class="list-group-item list-group-item-action">
                {{ name }} ({{ ticker }})
            </a>
            {% endfor %}
        </div>
    </aside>

    <div class="toggle-button">
        <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#stockSidebar" aria-expanded="true" aria-controls="stockSidebar">
            >
        </button>
    </div>

<script>
    const ticker = "{{ ticker }}";
    const chartContainer = document.getElementById('graph-container');

    function setChartSize() {
        const width = chartContainer.offsetWidth;
        const height = chartContainer.offsetHeight;
        chart.applyOptions({
            width: width,
            height: height
        });
    }

    const chart = LightweightCharts.createChart(chartContainer, {
        width: chartContainer.clientWidth,
        height: chartContainer.clientHeight,
        layout: {
            backgroundColor: '#ffffff',
            textColor: 'rgba(33, 56, 77, 1)',
        },
        grid: {
            vertLines: {
                color: 'rgba(197, 203, 206, 0.7)',
            },
            horzLines: {
                color: 'rgba(197, 203, 206, 0.7)',
            },
        },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
        },
        rightPriceScale: {
            borderColor: 'rgba(197, 203, 206, 0.8)',
        },
        timeScale: {
            borderColor: 'rgba(197, 203, 206, 0.8)',
        },
    });

    const candleSeries = chart.addCandlestickSeries();

    fetch(`/api/timeseries/${encodeURIComponent(ticker)}`)
        .then(response => response.json())
        .then(data => {
            if (data && Array.isArray(data)) {
                const formattedData = data.map(item => ({
                    time: Math.floor(new Date(item.time).getTime() / 1000),
                    open: parseFloat(item.open),
                    high: parseFloat(item.high),
                    low: parseFloat(item.low),
                    close: parseFloat(item.close)
                }));
                
                formattedData.sort((a, b) => a.time - b.time);
                
                candleSeries.setData(formattedData);

                chart.timeScale().fitContent();
            } else {
                console.error('Time series data is not in expected format:', data);
            }
        })
        .catch(error => console.error('Error fetching time series data:', error));

    window.addEventListener('resize', setChartSize);
    setChartSize();
</script>

</body>
</html>
