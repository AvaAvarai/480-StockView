<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="{{ url_for('static', filename='js/jquery-3.7.1.slim.min.js') }}"></script>
    <!-- Bootstrap JS -->
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='singleView.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300&display=swap" rel="stylesheet">
    <!-- LightweightCharts Development (swap 'development' to 'production' for stripped version) -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.development.js"></script>
    <title>{{ company_name }} - StockViewer WebApp</title>
</head>
<body>
    <div class="container-fluid">
        <div id="stock-body">
            <h2>{{ company_name }}</h2>
            <p>Ticker: {{ ticker }}</p>
            <p>Current Price: {{ price }}</p>
            <a href="/">Back to Home</a> <!-- Link back to home page -->
            <div id="graph-container" style="height: 300px; width: 600px;"></div>
        </div>
    </div>

<script>
const ticker = "{{ ticker }}"; // Get the ticker value from the template
const chart = LightweightCharts.createChart(document.getElementById('graph-container'), {
    width: 600,
    height: 300,
    layout: {
        backgroundColor: '#ffffff',
        textColor: 'rgba(33, 56, 77, 1)',
    },
    grid: {
        vertLines: {
            color: 'rgba(197, 203, 206, 0.7)',
        },
        horzLines: {
            color: 'rgba(197, 203, 206, 0.7)',
        },
    },
    crosshair: {
        mode: LightweightCharts.CrosshairMode.Normal,
    },
    rightPriceScale: {
        borderColor: 'rgba(197, 203, 206, 0.8)',
    },
    timeScale: {
        borderColor: 'rgba(197, 203, 206, 0.8)',
    },
});

const candleSeries = chart.addCandlestickSeries();

fetch(`/api/timeseries/${encodeURIComponent(ticker)}`)
    .then(response => response.json())
    .then(data => {
        console.log('Received data:', data); // Log data to the console
        if(data && Array.isArray(data)) {
            const formattedData = data.map(item => ({
                time: new Date(item.time).getTime() / 1000, // Ensure time is in seconds
                open: parseFloat(item.open),
                high: parseFloat(item.high),
                low: parseFloat(item.low),
                close: parseFloat(item.close)
            }));
            
            // Sort the formattedData array based on the time property in ascending order
            formattedData.sort((a, b) => a.time - b.time);
            
            console.log('Formatted data:', formattedData); // Log formatted data
            candleSeries.setData(formattedData);
        } else {
            console.error('Time series data is not in expected format:', data);
        }
    })
    .catch(error => console.error('Error fetching time series data:', error));

// Function to convert date string to the correct format (yyyy-mm-dd)
function convertDateFormat(dateString) {
    const parts = dateString.split(' '); // Split date and time parts
    const dateParts = parts[0].split('-'); // Split date into year, month, day
    return `${dateParts[0]}-${dateParts[1]}-${dateParts[2]}`; // Return date in yyyy-mm-dd format
}

</script>

</body>
</html>
